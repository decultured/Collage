<?xml version="1.0" encoding="utf-8"?> 
<mx:WindowedApplication 
	xmlns:mx="http://www.adobe.com/2006/mxml"
	xmlns:clg="Collage.Document.*"
	layout="absolute"
	minHeight="400"
	minWidth="500"
	height="600"
	width="800"
	x="0"
	y="0"
	showStatusBar="false"
	borderThickness="1"
	borderColor="#313131"
	dropShadowEnabled="true"
	applicationComplete="Initialize()"
    paste="HandlePaste(event)"
	nativeDragEnter="onDragIn(event)" 
	nativeDragDrop="onDrop(event)" >
	
	<mx:Style> 
		WindowedApplication
		{
			background-color:"0x777777";
			background-alpha:"1.0";
		}
	</mx:Style>
	<mx:Script>
	<![CDATA[
		import com.adobe.serialization.json.JSON;
		import Collage.Document.*;
		import Collage.Clips.Picture.*;
		import mx.graphics.ImageSnapshot;
		import mx.graphics.codec.*;
		import mx.controls.Alert;
		import mx.events.FlexEvent;
		import flash.desktop.Clipboard;
	    import flash.desktop.ClipboardFormats;
	    import flash.desktop.ClipboardTransferMode;
		import Collage.DataEngine.*;
		import Collage.DataEngine.*;
		import org.alivepdf.pdf.*;
		import org.alivepdf.pdf.PDF;	
		import org.alivepdf.display.*;
		import org.alivepdf.images.*;
		import org.alivepdf.layout.*;
		import org.alivepdf.saving.*;
//		private var _EditDocumentView:EditDocumentView;
		private var _Document:Document;

		private function Initialize():void
		{
			stage.addEventListener(KeyboardEvent.KEY_DOWN, HandleKeyDown); 
			DataEngine.LoadAllDataSets();

//			_Document = new Document(true);
//			_EditDocumentView = mainEditCanvas.view as EditDocumentView;
			_EditDocumentView.InitializeForEdit(inspectorWindow, optionsBox);
		}

		private function Fullscreen():void
		{
			if (stage.displayState == StageDisplayState.FULL_SCREEN_INTERACTIVE)
				stage.displayState = StageDisplayState.NORMAL;
			else
				stage.displayState = StageDisplayState.FULL_SCREEN_INTERACTIVE;
		}
		
		private function HandleKeyDown(event:KeyboardEvent):void
		{
		}
		
		public function HandlePaste(event:Event):void
		{
			if (Clipboard.generalClipboard.hasFormat(ClipboardFormats.BITMAP_FORMAT)) {
				_EditDocumentView.AddClipFromData(Clipboard.generalClipboard.getData(ClipboardFormats.BITMAP_FORMAT) as BitmapData);
			} else if (Clipboard.generalClipboard.hasFormat(ClipboardFormats.TEXT_FORMAT)) {
				_EditDocumentView.AddClipFromData(Clipboard.generalClipboard.getData(ClipboardFormats.TEXT_FORMAT) as String);
			}
		}
		
		public function SaveFile():void
		{
			var file:File = File.desktopDirectory.resolvePath("file.json");
			file.addEventListener(Event.SELECT, SaveFileEvent);
			file.browseForSave("Save As");
		}
			
		protected function SaveFileEvent(event:Event):void
		{
			var jsonFile:String = JSON.encode(_EditDocumentView.model.SaveToObject());
			
			var newFile:File = event.target as File;
			var fs:FileStream = new FileStream();
			try{
				fs.open(newFile,FileMode.WRITE);
				jsonFile = jsonFile.replace(/\n/g, File.lineEnding);
				fs.writeUTFBytes(jsonFile); 
				fs.close();
			} catch(e:Error){
				trace(e.message);
			}
		}
		
		public function SaveImage():void
		{
			var file:File = File.desktopDirectory.resolvePath("snapshot.png");
			file.addEventListener(Event.SELECT, SaveImageEvent);
			file.browseForSave("Save As");
		}
			
		protected function SaveImageEvent(event:Event):void
		{
			var snapshot:ImageSnapshot = ImageSnapshot.captureImage(_EditDocumentView);
			
			var newFile:File = event.target as File;
			var fs:FileStream = new FileStream();
			try{
				fs.open(newFile,FileMode.WRITE);
				fs.writeBytes(snapshot.data, 0, snapshot.data.length); 
				fs.close();
			} catch(e:Error){
				trace(e.message);
			}
		}
		
		public function SavePDF():void
		{
			var file:File = File.desktopDirectory.resolvePath("report.pdf");
			file.addEventListener(Event.SELECT, SavePDFEvent);
			file.browseForSave("Save As");
		}
			
		protected function SavePDFEvent(event:Event):void
		{
			var snapshot:ImageSnapshot = ImageSnapshot.captureImage(_EditDocumentView, 0, new JPEGEncoder());
			var snapshotBitmap:BitmapData = ImageSnapshot.captureBitmapData(_EditDocumentView);

			var newPDF:PDF = new PDF(Orientation.LANDSCAPE, Unit.MM, Size.LETTER);
			newPDF.setDisplayMode(Display.FULL_WIDTH); 

			newPDF.addPage();
//			newPDF.addImageStream(snapshot.data, ColorSpace.DEVICE_RGB, new Resize ( Mode.FIT_TO_PAGE, Position.CENTERED ));
			newPDF.addImage(new Bitmap(snapshotBitmap), new Resize ( Mode.FIT_TO_PAGE, Position.CENTERED ));
/*
			newPDF.setFont(FontFamily.ARIAL , Style.NORMAL, 12);
			newPDF.addText("Claimant Name: " + this.firstName.text + " " + lastName.text,10,40);
			newPDF.addText("Date: " + this.date.text,10,50);
			newPDF.addTextNote(48,45,100,2,"Claim Filed on: " + this.date.text + " today's date: " + new Date());
			newPDF.addText("Policy #: " + this.policyNum.text,10,60);
			newPDF.addText("Contact #: " + this.contact.text,10,70);
			newPDF.addText(this.claimNum.text,10,80);
			newPDF.addText("Claim Description:",10,90);
			newPDF.setXY(10,95);
			newPDF.addMultiCell(200,5,desc.text);
*/
			
			var newFile:File = event.target as File;
			var fs:FileStream = new FileStream();
			try{
				fs.open(newFile,FileMode.WRITE);
				var pdfBytes:ByteArray = newPDF.save(Method.LOCAL);
				fs.writeBytes(pdfBytes); 
				fs.close();
			} catch(e:Error){
				trace(e.message);
			}
		}
		
		private function onDragIn(event:NativeDragEvent):void{
			NativeDragManager.acceptDragDrop(this);
		}

		private function onDrop(event:NativeDragEvent):void{
			var dropfiles:Array = event.clipboard.getData(ClipboardFormats.FILE_LIST_FORMAT) as Array;
			for each (var file:File in dropfiles){
				var ext:String = file.extension.toLowerCase();
				
				if (ext == "png" || ext == "jpg" || ext == "jpeg" || ext == "gif") {
					var newClip:PictureClip = _EditDocumentView.AddClipByType("image") as PictureClip;
					newClip.url = file.url;
				} if (ext == "csv") {
					DataEngine.UploadCSV(file);
				}
				else {
					//Alert.show("Unmapped Extension");
				}
			}
		}
	]]>
	</mx:Script>
    <mx:HDividedBox top="40" left="0" right="0" bottom="0" dropShadowEnabled="false" >
        <mx:Canvas label="Canvas 1" width="100%" height="100%" color="0x323232" backgroundColor="#ACACAC" click="_EditDocumentView.BackgroundClick(event);">
			<mx:Box top="0" left="0" right="0" bottom="0" paddingLeft="20" paddingRight="20" paddingTop="20" paddingBottom="20"  horizontalAlign="center" verticalAlign="middle">
				<clg:EditDocumentView id="_EditDocumentView" 
					width="800" height="600" 
					dropShadowEnabled="true" 
					click="_EditDocumentView.BackgroundClick(event);" 
					backgroundColor="#FFFFFF" backgroundAlpha="1" borderThickness="0"
					horizontalScrollPolicy="off"
					verticalScrollPolicy="off" >
					<mx:HBox id="optionsBox" visible="false" paddingBottom="6" paddingTop="6">
						<mx:Image id="lockButton" source="@Embed('../assets/icons/lock.png')" click="_EditDocumentView.lockSelected()" />
						<mx:Image id="deleteButton" source="@Embed('../assets/icons/delete.png')" click="_EditDocumentView.deleteSelected()" />
					</mx:HBox>			
				</clg:EditDocumentView>
			</mx:Box>
        </mx:Canvas>
        <mx:Box id="inspectorWindow" width="250" minWidth="250" height="100%" backgroundColor="#ACACAC" backgroundAlpha="1" horizontalScrollPolicy="off" paddingLeft="5" paddingRight="5" paddingTop="5" paddingBottom="5"  >
        </mx:Box>
    </mx:HDividedBox>
	<mx:ApplicationControlBar height="40" top="0" left="0" right="0" paddingTop="3" paddingBottom="3" cornerRadius="0" dropShadowEnabled="false" backgroundColor="#d6d6d6">
		<mx:Image id="fullscreenBtn" source="@Embed('../assets/icons/fullscreen.png')" width="32" height="32" click="Fullscreen();" />
		<mx:Image id="saveImageBtn" source="@Embed('../assets/icons/save_image.png')" width="32" height="32" click="SaveImage();" />
		<mx:Image id="savePDFBtn" source="@Embed('../assets/icons/pdf_icon.png')" width="32" height="32" click="SavePDF();" />
		<mx:Image id="saveFileBtn" source="@Embed('../assets/icons/document-save.png')" width="32" height="32" click="SaveFile();" />
		<mx:Image id="PasteBtn" source="@Embed('../assets/icons/paste.png')" width="32" height="32" click="HandlePaste(null);" />
		<mx:VRule height="32" />
		<mx:Image id="addImageBtn" source="@Embed('../assets/icons/new/image.png')" width="24" height="24" click="_EditDocumentView.AddClipByType('image', new Rectangle(150, 150, 300, 300));" />
		<mx:Image id="addLabelBtn" source="@Embed('../assets/icons/new/label.png')" width="24" height="24" click="_EditDocumentView.AddClipByType('label', new Rectangle(150, 150, 300, 300));" />
		<mx:Image id="addTextBoxBtn" source="@Embed('../assets/icons/text_box.png')" width="32" height="32" click="_EditDocumentView.AddClipByType('textbox', new Rectangle(150, 150, 300, 300));" />
		<mx:Image id="addLineChartBtn" source="@Embed('../assets/icons/new/line-chart.png')" width="24" height="24" click="_EditDocumentView.AddClipByType('linechart', new Rectangle(150, 150, 300, 300));" />
		<mx:Image id="addBarChartBtn" source="@Embed('../assets/icons/new/bar-chart.png')" width="24" height="24" click="_EditDocumentView.AddClipByType('barchart', new Rectangle(150, 150, 300, 300));" />
		<mx:Image id="addPieChartBtn" source="@Embed('../assets/icons/new/pie-chart.png')" width="24" height="24" click="_EditDocumentView.AddClipByType('piechart', new Rectangle(150, 150, 300, 300));" />
		<mx:Image id="addGuageBtn" source="@Embed('../assets/icons/new/guage.png')" width="24" height="24" click="_EditDocumentView.AddClipByType('guage', new Rectangle(150, 150, 300, 300));" />
		<mx:Image id="addTableBtn" source="@Embed('../assets/icons/table.png')" width="32" height="32" click="_EditDocumentView.AddClipByType('table', new Rectangle(150, 150, 300, 300));" />
		<mx:Image id="addDataLabelBtn" source="@Embed('../assets/icons/data-label.png')" width="32" height="32" click="_EditDocumentView.AddClipByType('datalabel', new Rectangle(150, 150, 300, 300));" />
	</mx:ApplicationControlBar>
</mx:WindowedApplication>